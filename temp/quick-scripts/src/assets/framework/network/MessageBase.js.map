{"version":3,"sources":["assets\\framework\\network\\MessageBase.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import {SocketTag} from \"./MessageType\"\nimport {Message} from \"./Message\"\nimport { connManager } from \"./ConnectManager\";\nexport class MessageBase {\n\n\tprivate _socketKey: string;\n\tprivate _allFuncs: {[cmd: number]: Function};\n\n\tCmd  = {}\n\tError = {}\n\tpublic constructor() {\n\t\tthis._allFuncs = {};\n\n\t\tfor (var i in game.Command)\n        {\n            let v = game.Command[i]\n            this.Cmd[v] = i;\n\t\t}\n\t\tfor (var i in game.ErrorCode)\n        {\n            let v = game.ErrorCode[i]\n            this.Error[v] = i;\n\t\t}\n\t\t\n\t}\n\n\tpublic useSocketKey(key: string){\n\t\tthis._socketKey = key;\n\t}\n\n\tpublic addListener(cmd: any, func: Function){\n\t\tthis._allFuncs[cmd] = func;\n\t}\n\n\tpublic removeListener(cmd: any){\n\t\tif(this._allFuncs[cmd] != null){\n\t\t\tthis._allFuncs[cmd] = null;\n\t\t}\n\t}\n\n\tpublic onMessage(obj: any){\n\t\tif(obj.type == SocketTag.KSOCKET_MESSAGE){\n\t\t\tlet int8a = new Uint8Array(obj.msg);\n\t\t\tlet buffer = new flatbuffers.ByteBuffer(int8a);\n\t\t\tlet msg:any = game.Package.getRootAsPackage(buffer);\n\t\t\tif(this._allFuncs[msg.cmd()] != null){\n\t\t\t\treturn this._allFuncs[msg.cmd()].call(this, msg);\n\t\t\t}else return this.onHandler(msg);\n\t\t} else {\n\t\t\tthis.onSocket(obj.type);\n\t\t\treturn true;\n\t\t}\n\t}\n\n\t/**\n\t * 处理socket消息\n\t * @param type \n\t */\n\tpublic onSocket(type: SocketTag){\n\n\t}\n\t\n\t/**\n\t * 重写消息处理函数\n\t * return 消息处理结果，处理完成返回真，否则返回假(消息会入消息队列，等待下次处理)\n\t */\n\tpublic onHandler(msg: game.Package){\n\t\t\n\t\treturn false;\n\t}\n\n\tpublic sendMessage(msg: Message){\n\t\tconnManager.sendMessage(msg, this._socketKey);\n\t}\n\n\tpublic onDestory(){\n\t\tthis._allFuncs = null;\n\t}\n\n\tsend(cmd,cmdstr=\"\",procedure=null,build = null)\n\t{\n\t\tconsole.log(\"Send Message : [\" + this.Cmd[cmd] +\"]\")\n        let socket = connManager.getDefault();\n\t\tlet msg = new Message(cmd);\n\t\tlet ds = game[cmdstr] \n        if(ds != null)\n        {\n\t\t\tif(build == null)\n\t\t\t{\n\t\t\t\tbuild = this.createBuilder();\n\t\t\t}\n            let startFunc = ds[\"start\" + cmdstr] \n\t\t\tlet endFunc = ds[\"end\" + cmdstr] \n\t\t\tstartFunc.call(ds, build);\n            if(procedure)\n            {\n                procedure(build)\n                //game[cmd].addTaskId(build,task_id);\n            }\n\t\t\tbuild.finish(endFunc.call(ds,build))\n\t\t\tmsg.addBuilder(build);\n\t\t}else{\n\t\t\tmsg.addString(cmdstr);\n\t\t}\n        socket.sendMessage(msg);\n    }\n\n    createBuilder()\n    {\n        return new flatbuffers.Builder();\n    }\n\t\n}"]}