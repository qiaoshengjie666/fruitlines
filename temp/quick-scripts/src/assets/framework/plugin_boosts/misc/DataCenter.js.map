{"version":3,"sources":["assets\\framework\\plugin_boosts\\misc\\DataCenter.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { event } from \"../utils/EventManager\";\n\n\nconst all_class_properties = {}\n\nconst all_registed_class = {}\nexport function dc(name,serializable = true):Function\n{\n    return function (target:any)\n    {\n        // target.endRegister(name);\n        let proto:any = target['prototype'].constructor;\n        // let cls = all_class_properties[proto]\n        all_registed_class[target] = {name,serializable};\n    }\n}\nexport function field(obj?:{default?:any}) {\n    return function (target: any, propertyName: string) {\n        if(obj && obj.default)\n            target[propertyName] = obj.default;\n        // target.register(propertyName,target[propertyName])\n        let constructor = target.constructor\n        let cls = all_class_properties[constructor]\n        if(cls == null)\n        {\n            cls = []\n            all_class_properties[constructor] = cls;\n        }\n        cls.push(propertyName);\n    }\n}\n\n\nexport default class DataCenter\n{\n    private __namespace:string = \"DataCenter\"\n    static alldata = {}\n    private kvs = {}\n    private kts = {}\n    constructor()\n    {\n        this.kvs = {}\n        this.kts = {}\n    }\n\n    private registerFields(namespace?)\n    {\n        console.log(this);\n        let target = this[\"__proto__\"].constructor \n        let cls = all_class_properties[target]\n        let cfg = all_registed_class[target]\n        // let proto:any = target['prototype'];\n        for(var i in cls)\n        {\n            let k = cls[i];\n            if(typeof(k) == \"function\") continue;\n            this.register(k,this[k])\n            delete this[k]; //删除默认属性 ,否则设置 setter getter 会失效\n        }\n        namespace = namespace ||  cfg.name;\n        this.endRegister(namespace,cfg.serializable)\n    }\n\n    register(k,defaultValue)\n    {\n        let proto:any = this.constructor[\"prototype\"]\n        let self = this;\n        proto.__defineGetter__(k,function(){\n            return self.getData(k);\n        })\n        proto.__defineSetter__(k,function(s){\n            self.setData(k,s)\n        }) \n        \n        this.kvs[k] = defaultValue;\n        let type = typeof(defaultValue);\n        this.kts[k] =  type;\n        console.log(\"[DataCenter] register :\" + k + \":\" + defaultValue +\"(\"+type+\")\")\n    }\n \n    setData(k,nv)\n    {\n        let v = this.kvs[k]\n        if(v == nv ) return;\n        let type = this.kts[k]\n        let kk =this._field_(k)\n        if(type != typeof(nv))\n        {\n            console.warn(\"[DataCenter] wrong type <\"+typeof(nv)+\"> for :\" + kk +\"<\"+type+\"> ,converting...\")\n            if(type == \"number\")\n                nv = Number(nv)\n            else if(type == \"boolean\")\n            {\n                nv = (nv == \"true\") ? true :false\n            }\n        }\n        this.kvs[k] = nv;\n        console.log(\"[DataCenter] onValueChanged\" , kk,nv);\n        event.emit(kk,nv,v)\n    }\n\n    private _field_(k)\n    {\n        return this.__namespace +\".\" + k\n    }\n\n    getData(k)\n    {\n        return this.kvs[k];\n    }\n\n    limit(v,min,max)\n    {\n        if(v > max)\n        {\n            return max;\n        }else if(v < min)\n        {\n            return 0;\n        }else{\n            return v;\n        }\n    }\n\n    addData(k,c)\n    {\n        c = Number(c)\n        if(c == null) return;\n        let v = this.kvs[k]\n        let nv =  Number(v) + c\n        this.kvs[k] = nv\n        event.emit(this._field_(k),nv,v)\n    }\n\n    private load()\n    {\n        for (var k in this.kvs)\n        {\n            let fromstroage = localStorage.getItem(this._field_(k))\n            let v:any = fromstroage\n            if(fromstroage)\n            {\n                let type = this.kts[k]\n                if(type == \"number\")\n                {\n                    v = Number(fromstroage);\n                }else if(type == \"boolean\")\n                {\n                    v = fromstroage == \"true\"?true:false;\n                }\n            }else{\n                v = this.getData(k);\n            }\n            this.kvs[k] = v;\n        }\n    }\n\n    save()\n    {\n        console.log(\"[DataCenter] save :==================================\")\n        for (var k in this.kvs)\n        {\n            let v = this.kvs[k]\n            let kk = this._field_(k)\n            localStorage.setItem(kk,v.toString());\n            console.log(cc.js.formatStr(\"%s:%s\" ,kk,v))\n        }\n        console.log(\"[DataCenter] save succ :==================================\")\n        // localStorage.setItem(\"#1_coin\",this.getData(\"coin\"));\n    }\n\n    private endRegister(s ,serializable = true)\n    {\n        this.__namespace = s;\n        DataCenter.alldata[s] = this;\n        if(serializable)\n        {\n            this.load()\n            this.save();\n        }\n    }\n\n    static off(k,callback,target?)\n    {\n        event.off(k,callback,target);\n    }\n\n    static on(k,callback,target?)\n    {\n       event.on(k ,callback,target)\n       this.set(k,this.get(k)) \n    }\n\n    static get(k)\n    {\n        let strs = k.split(\".\")\n        let namespace = strs[0];\n        let name = strs[1];\n        let target = DataCenter.alldata[namespace]\n        if(target)\n            return target[name]\n        else \n            return null;\n    }\n\n    static set(k,v)\n    {\n        let strs = k.split(\".\")\n        let namespace = strs[0];\n        let name = strs[1];\n        let target = DataCenter.alldata[namespace]\n        if(target)\n        {\n            target[name] = v;\n        }\n    }\n\n    static register(cls)\n    {\n        let v = new cls();\n        v.registerFields()\n        return v;\n    }\n}"]}