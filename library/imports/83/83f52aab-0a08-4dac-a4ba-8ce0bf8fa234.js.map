{"version":3,"sources":["assets\\framework\\plugin_boosts\\gamesys\\FSM.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\nconst {ccclass, property} = cc._decorator;\n\nexport class State \n{\n    name:string;\n    id: number;\n\n    constructor(id?,name?)\n    {\n        this.id = id;\n        this.name = name;\n    }\n    onEnter(params?){}\n    onExit(){}\n    onUpdate(dt){}\n    //messages \n    on(){}\n    off(){}\n\n    __interval_callbacks = []\n\n    clearIntervals()\n    {\n        this.__interval_callbacks.splice(0 ,this.__interval_callbacks.length)\n    }\n\n    interval_id:number = 0;\n\n    setInterval(interval,callback,target?)\n    {\n        let id = ++ this.interval_id;\n        let timer = 0;\n        this.__interval_callbacks.push({id,callback,target,interval,timer});\n        return id;\n    }\n\n    clearInterval(id)\n    {\n        this.__interval_callbacks.splice(this.__interval_callbacks.indexOf(id))\n    }\n\n\n    setTimeout(delay,callback,target?)\n    {\n        let id = ++ this.interval_id;\n        let timer = 0;\n        this.__interval_callbacks.push({id,callback,target,delay,timer});\n        return id;\n    }\n\n    clearTimeout(id)\n    {\n        this.clearInterval(id)\n    }\n\n    invokeIntervals(dt)\n    {\n        for (let i = 0; i < this.__interval_callbacks.length; i++) {\n            const element = this.__interval_callbacks[i];\n            element.timer = element.timer + dt;\n            if(element.interval)\n            {\n                if(element.timer >= element.interval)\n                {\n                    element.timer = 0;\n                    // call\n                    element.callback.call(element.target)\n                }\n            }else if(element.delay)\n            {\n                if(element.timer >= element.delay)\n                {\n                    // call\n                    element.callback.call(element.target)\n                    this.__interval_callbacks.splice(i);\n                    i --;\n                }\n            }\n        }\n    }\n}\n\nclass CustomState extends State\n{\n    __enterFunc:Function;\n    __exitFunc:Function;\n    __updateFunc:Function;\n    __target:any;\n    constructor(target,id,name,pattern)\n    {\n        super(id,name);\n        let enterName = cc.js.formatStr(pattern,\"onEnter\",this.name)\n        let updateName = cc.js.formatStr(pattern,\"onUpdate\",this.name)\n        let exitName = cc.js.formatStr(pattern,\"onExit\",this.name)\n        this.__target = target;\n        this.__enterFunc = this.__target[enterName];\n        this.__updateFunc = this.__target[updateName];\n        this.__exitFunc = this.__target[exitName];\n        \n    }\n    onEnter(params){\n        this.clearIntervals();\n        if (this.__enterFunc)\n        {\n            this.__enterFunc.call(this.__target,this,params);\n        }\n    }\n    onExit(){\n        if (this.__exitFunc)\n        {\n            this.__exitFunc.call(this.__target,this);\n        }\n    }\n    onUpdate(dt){\n        this.invokeIntervals(dt);\n        if (this.__updateFunc)\n        {\n            this.__updateFunc.call(this.__target,this,dt);\n        }\n    }\n\n}\n\nexport default class FSM extends cc.Component\n{\n    c:State;\n    p:State;\n    _target:any;\n\n    timeElapsed:number = 0;\n\n    _states:{[index:number]:State } = {}\n\n    _isPaused = false;\n\n    namePattern:string;\n\n    log:boolean = false;\n\n    get target():any\n    {\n        return this._target;\n    }\n\n    init(target:any)\n    {\n        this._target = target;\n        this.timeElapsed = 0;\n    }\n\n    getState(stateId)\n    {\n        return this._states[stateId];\n    }\n\n    getCurrentState()\n    {\n        return this.c\n    }\n\n    getPreviousState()\n    {\n        return this.p;\n    }\n\n\n\n    addStates(states:any,callbackNamePattern = \"%s_%sState\")\n    {\n        let keys = Object.keys(states);\n        let enumLen = (keys.length/2);\n        this.namePattern = callbackNamePattern;\n        for(var i = 0;i < enumLen;i++)\n        {\n            let key = keys[i]\n            let value = states[key];\n            \n            this.addState(key,value)\n        }\n    }\n\n    addState(id,name,enterCallback?,exitCallback?,updateCallback?,target?)\n    {\n        if(this.log)\n            console.log(\"[FSM]\"+this.target.__classname__ + \"(\"+ this.target.name+\")\"+\" Add State :\" ,id, name)\n        let state = new CustomState(this.target,id,name,this.namePattern);\n        this._states[id] = state;\n        if(enterCallback)\n            state.__enterFunc = enterCallback;\n        if(exitCallback)\n            state.__exitFunc = exitCallback;\n        if(updateCallback)\n            state.__updateFunc = updateCallback;\n        if(target)\n            state.__target = target;\n    }\n\n    /**\n     * first state \n     * @param: state index or State\n     */\n    enterState(stateId:number,params?)\n    {\n        this.timeElapsed = 0\n        let state = this._states[stateId]\n        this.c = state;\n        state.onEnter(params);\n        if(this.log)\n            console.log(\"[FSM]\"+this.target.__classname__ +\" First State:\" ,state.name)\n    }\n\n    revertState()\n    {\n    \tthis.changeState(this.p.id);\n    }\n\n\n    pause()\n    {\n        this._isPaused = true;\n    }\n\n    resume()\n    {\n        this._isPaused = false;\n    }\n\n    resetCurrentState()\n    {\n        this.timeElapsed = 0\n        console.log(cc.js.formatStr(\"[FSM] %s reset currentState\",this.target.__classname__))\n        this.c.onExit();\n        this.c.onEnter();\n    }\n\n    changeState(stateId:number,params?)\n    {\n        let state = this._states[stateId]\n        if(state == null)\n        {\n            console.warn(\"[FSM] invalid state for stateId \" + stateId +\" of : \" +  this.target.__classname__)\n            return;\n        }\n        if(this._isPaused) \n        {\n            console.warn(\"[FSM] fsm is paused ! \"+this.target.__classname__+\" changeState to <\"+ state.name + \"> failed!\")\n            return \n        }\n        if(stateId == this.c.id) return;\n        this.timeElapsed = 0\n        this.c.onExit();\n        this.p = this.c;\n        this.c = state;\n        if(this.log)\n            console.log(cc.js.formatStr(\"[FSM] %s (%s): %s -> %s\",this.target.__classname__,this.name,this.p.name , state.name))\n        this.c.onEnter(params);\n        \n    }\n\n    isInState(stateId)\n    {\n        return this.c == this._states[stateId]\n    }\n    static debug = false;\n    update(dt)\n    {\n        if(this._isPaused) return;\n        if(FSM.debug)\n            dt = 0.016 ; // use real deta\n        this.timeElapsed += dt;\n        if(this.c)\n            this.c.onUpdate(dt);\n    }\n\n    \n}"]}