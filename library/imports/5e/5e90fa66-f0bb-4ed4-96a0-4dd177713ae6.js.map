{"version":3,"sources":["assets\\framework\\plugin_boosts\\gamesys\\PsFx.ts"],"names":[],"mappings":";;;;;AAAA,mCAA8B;AAExB,IAAA,KAAsB,EAAE,CAAC,UAAU,EAAlC,OAAO,aAAA,EAAE,QAAQ,cAAiB,CAAC;AAG1C;IAAkC,wBAAY;IAA9C;QAAA,qEA+KC;QA7KG,iCAAiC;QACjC,eAAS,GAAuB,EAAE,CAAA;QAElC,4BAA4B;QAC5B,gBAAU,GAAkB,EAAE,CAAA;QAE9B,8CAA8C;QAC9C,cAAQ,GAAO,IAAI,CAAC;QAEpB,sBAAsB;QAEtB,sBAAsB;QACtB,eAAe;QAEf,eAAS,GAAW,KAAK,CAAC;QAG1B,SAAG,GAAgB,IAAI,CAAA;QAGvB,YAAM,GAAa,IAAI,CAAA;QAEvB,gBAAU,GAAU,CAAC,CAAC;QAGtB,cAAQ,GAAU,CAAC,CAAC,CAAE;QAGtB,qBAAe,GAAU,CAAC,CAAC,CAAC;QAG5B,gBAAU,GAAU,CAAC,CAAC;QAGtB,uBAAiB,GAAW,KAAK,CAAC;;QA0IlC,iBAAiB;IACrB,CAAC;IAxIG,qBAAM,GAAN;QAEI,IAAG,IAAI,CAAC,MAAM,IAAI,IAAI,EACtB;YACI,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC;SAC9C;QACD,IAAI,IAAI,GAAG,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,SAAS,CAAC,CAAA;QAC1C,IAAG,IAAI,EACP;YACI,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SAC9B;QACD,IAAI,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,cAAc,CAAC,CAAA;QAClD,OAAO,IAAI,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;QACvC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,EAAE,EAAE;YAC9C,IAAM,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAA;YACnC,IAAI,EAAE,GAAG,KAAK,CAAC,YAAY,CAAC,EAAE,CAAC,cAAc,CAAC,CAAA;YAC9C,IAAG,EAAE;gBACD,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;iBACxB;gBACA,IAAI,MAAI,GAAG,KAAK,CAAC,YAAY,CAAC,EAAE,CAAC,SAAS,CAAC,CAAA;gBAC3C,IAAG,MAAI;oBACH,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,MAAI,CAAC,CAAC;aAClC;SACJ;QACD,IAAG,OAAM,CAAC,WAAW,CAAC,IAAG,WAAW,EACpC;YACI,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,eAAe,CAAC,CAAC;YAC/D,IAAG,CAAC,IAAI,CAAC,QAAQ;gBACb,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,sBAAsB,CAAC,WAAW,CAAC,eAAe,CAAC,CAAC;SAChF;IACL,CAAC;IAED,mBAAI,GAAJ,UAAK,KAAwB,EAAC,WAAkB;QAAhD,iBA6EC;QA7EI,sBAAA,EAAA,YAAwB;QAAC,4BAAA,EAAA,kBAAkB;QAE5C,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,GAAG,GAAG,CAAC,CAAC;QACZ,IAAG,KAAK,EACR;YACI,IAAI,CAAC,GAAG,GAAG,KAAK,CAAA;SACnB;QACD,IAAG,WAAW;YACV,IAAI,CAAC,MAAM,CAAC,WAAW,GAAG,WAAW,CAAC;QAE1C,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;QACxB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAC5C,IAAM,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;YAClC,OAAO,CAAC,WAAW,EAAE,CAAC;YACtB,IAAG,GAAG,GAAG,OAAO,CAAC,QAAQ,EACzB;gBACI,GAAG,GAAG,OAAO,CAAC,QAAQ,GAAG,OAAO,CAAC,IAAI,GAAG,OAAO,CAAC,OAAO,CAAA;aAC1D;SACJ;QACD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAC7C,IAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;YACnC,IAAI,KAAK,GAAG,OAAO,CAAC,QAAQ,EAAE,CAAA;YAC9B,IAAG,KAAK,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAC5B;gBACI,IAAI,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAA;gBACnB,IAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,GAAC,IAAI,CAAC,KAAK,CAAA;gBACvC,IAAG,QAAQ,GAAG,GAAG,EACjB;oBACI,GAAG,GAAG,QAAQ,CAAC;iBAClB;gBACD,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;aAC3B;SACJ;QAED,IAAG,IAAI,CAAC,GAAG,EACX;YACI,gBAAM,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,EAAC,KAAK,CAAC,CAAC;SACrC;QAED,IAAG,IAAI,CAAC,QAAQ,EAChB;YACI,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,EAAE,EAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YAChD,GAAG,GAAG,IAAI,CAAC,QAAQ,CAAC;YACpB,IAAG,GAAG,IAAI,CAAC,EACX;gBACI,OAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAC,MAAM;oBAC9B,6EAA6E;oBAC7E,oCAAoC;oBACpC,iCAAiC;oBACjC,KAAK;oBACL,KAAI,CAAC,QAAQ,CAAC,gBAAgB,CAAC,WAAW,CAAC,WAAW,CAAC,QAAQ,EAAE,UAAA,CAAC;wBAC9D,OAAO,CAAC,GAAG,CAAC,wBAAwB,CAAC,CAAC;wBACtC,IAAG,KAAI,CAAC,iBAAiB,EACzB;4BACI,KAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC;yBAChC;6BAAI;4BACD,KAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAA;yBAC7B;oBACL,CAAC,CAAC,CAAA;gBACN,CAAC,CAAC,CAAA;aACL;SACJ;aAAI;YACD,GAAG,GAAG,GAAG,GAAG,GAAG,CAAC;SACnB;QACD,oDAAoD;QACpD,OAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAC,MAAM;YAC9B,UAAU,CAAC,UAAA,CAAC;gBACR,IAAG,CAAC,KAAI,CAAC,OAAO;oBAAE,OAAM;gBACxB,IAAG,KAAI,CAAC,iBAAiB,EACzB;oBACI,KAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC;iBAChC;qBAAI;oBACD,KAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAA;iBAC7B;YACL,CAAC,EAAC,GAAG,GAAG,IAAI,CAAC,CAAA;QACjB,CAAC,CAAC,CAAA;IACN,CAAC;IAED,2BAAY,GAAZ,UAAa,QAAQ;QAEjB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAC5C,IAAM,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;YAClC,OAAO,CAAC,UAAU,EAAE,CAAC;SACxB;QACD,IAAG,IAAI,CAAC,eAAe,GAAG,CAAC,EAC3B;YACI,IAAI,GAAG,GAAG,EAAE,CAAC,QAAQ,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,EAAC,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAA;YAC7E,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAA;SAC3B;aAAI;YACD,QAAQ,EAAE,CAAC;SACd;IACL,CAAC;IAED,oBAAK,GAAL;QACI,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;IACxB,CAAC;IAED,oBAAK,GAAL;IAEA,CAAC;IAzJD;QADC,QAAQ,CAAC,EAAC,IAAI,EAAE,EAAE,CAAC,SAAS,EAAC,CAAC;qCACR;IAGvB;QADC,QAAQ,CAAC,EAAE,CAAC,MAAM,CAAC;wCACG;IAKvB;QADC,QAAQ;0CACa;IAGtB;QADC,QAAQ;iDACmB;IAG5B;QADC,QAAQ;4CACa;IAGtB;QADC,QAAQ;mDACyB;IApCjB,IAAI;QADxB,OAAO;OACa,IAAI,CA+KxB;IAAD,WAAC;CA/KD,AA+KC,CA/KiC,EAAE,CAAC,SAAS,GA+K7C;kBA/KoB,IAAI","file":"","sourceRoot":"/","sourcesContent":["import Device from \"./Device\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class PsFx extends cc.Component {\n    \n    // @property([cc.ParticleSystem])\n    particles:cc.ParticleSystem[] = []\n\n    // @property([cc.Animation])\n    animations:cc.Animation[] = []\n\n    // armature:dragonBones.ArmatureDisplay = null\n    armature:any = null;\n\n    // name:string = null;\n\n    // _callback:Function;\n    // _target:any;\n\n    isPlaying:boolean = false;\n\n    @property({type: cc.AudioClip})\n    sfx:cc.AudioClip = null\n\n    @property(cc.Sprite)\n    sprite:cc.Sprite = null\n\n    playedTime:number = 0;\n\n    @property\n    duration:number = -1 ;\n\n    @property\n    fadeAfterFinish:number = -1;\n    \n    @property\n    repeatTime:number = 1;\n\n    @property\n    removeAfterFinish:boolean = false;\n\n\n    onLoad()\n    {\n        if(this.sprite == null)\n        {\n            this.sprite = this.getComponent(cc.Sprite);\n        }\n        let anim = this.getComponent(cc.Animation)\n        if(anim)\n        {\n            this.animations.push(anim);\n        }\n        let root_ps = this.getComponent(cc.ParticleSystem)\n        root_ps && this.particles.push(root_ps)\n        for (let i = 0; i < this.node.childrenCount; i++) {\n            const child = this.node.children[i]\n            let ps = child.getComponent(cc.ParticleSystem)   \n            if(ps)\n                this.particles.push(ps);\n            else{\n                let anim = child.getComponent(cc.Animation)\n                if(anim)\n                    this.animations.push(anim);\n            }\n        }\n        if(typeof(dragonBones) !=\"undefined\")\n        {\n            this.armature = this.getComponent(dragonBones.ArmatureDisplay);\n            if(!this.armature)\n                this.armature = this.getComponentInChildren(dragonBones.ArmatureDisplay);\n        }\n    }\n\n    play(audio:cc.AudioClip= null,spriteFrame = null)\n    {\n        this.isPlaying = true;\n        let dur = 0;\n        if(audio)\n        {\n            this.sfx = audio\n        }\n        if(spriteFrame)\n            this.sprite.spriteFrame = spriteFrame;\n        \n        this.node.active = true;\n        for (let i = 0; i < this.particles.length; i++) {\n            const element = this.particles[i];\n            element.resetSystem();\n            if(dur < element.duration)\n            {\n                dur = element.duration + element.life + element.lifeVar\n            }\n        }\n        for (let i = 0; i < this.animations.length; i++) {\n            const element = this.animations[i];\n            let clips = element.getClips()\n            if(clips && clips.length > 0)\n            {\n                let clip = clips[0]\n                let duration = clip.duration/clip.speed\n                if(duration > dur)\n                {\n                    dur = duration;\n                }\n                element.play(clip.name);\n            }\n        }\n\n        if(this.sfx)\n        {\n            Device.playEffect(this.sfx,false);\n        }\n        \n        if(this.armature)\n        {\n            this.armature.playAnimation(\"\",this.repeatTime);\n            dur = this.duration;\n            if(dur <= 0)\n            {\n                return new Promise((resolve,reject)=>{\n                    // this.armature.addEventListener(dragonBones.EventObject.LOOP_COMPLETE, _=>{\n                    //     console.log(\"loop complete\");\n                    //     this.fadeOnFinish(resolve)\n                    // })\n                    this.armature.addEventListener(dragonBones.EventObject.COMPLETE, _=>{\n                        console.log(\"armature play complete\");\n                        if(this.removeAfterFinish)\n                        {\n                            this.node.removeFromParent();\n                        }else{\n                            this.fadeOnFinish(resolve)\n                        }\n                    })\n                })\n            }\n        }else{\n            dur = dur + 0.1;\n        }\n        // console.log(\"[psfx] play : \" ,  this.name,  dur);\n        return new Promise((resolve,reject)=>{\n            setTimeout(_=>{\n                if(!this.isValid) return\n                if(this.removeAfterFinish)\n                {\n                    this.node.removeFromParent();\n                }else{\n                    this.fadeOnFinish(resolve)\n                }\n            },dur * 1000)\n        })\n    }\n\n    fadeOnFinish(callback)\n    {\n        this.isPlaying = false;\n        for (let i = 0; i < this.particles.length; i++) {\n            const element = this.particles[i];\n            element.stopSystem();\n        }\n        if(this.fadeAfterFinish > 0)\n        {\n            let seq = cc.sequence(cc.fadeOut(this.fadeAfterFinish),cc.callFunc(callback))\n            this.node.runAction(seq)\n        }else{\n            callback();\n        }\n    }\n\n    reset(): any {\n        this.playedTime = 0;\n    }\n\n    start () {\n\n    }\n\n    // update (dt) {}\n}\n"]}